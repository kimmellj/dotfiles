# Action,Command
# Start,limactl start dev-env.yaml
# Stop,limactl stop dev-env
# SSH Shell,limactl shell dev-env
# Docker (inside),limactl shell dev-env docker ps
# View Logs,tail -f ~/.lima/dev-env/serial.log

# Virtual Machine Engine
vmType: "vz" # Apple Virtualization Framework (Native M-series speed)

# Hardware Resources
cpus: 4
memory: "12GiB"
disk: "100GiB"

# OS Images: Debian 12 "Bookworm" (Stable)
images:
  - location: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-arm64.qcow2"
    arch: "aarch64"

# Rosetta: Run Intel binaries on ARM Linux transparently
vmOpts:
  vz:
    rosetta:
      enabled: true
      binfmt: true

# Integration
mounts:
  - location: "~/code"
    writable: true
ssh:
  forwardAgent: true

# Forward the Docker Socket to macOS
# This allows JetBrains/VS Code to talk to Docker inside the VM
# echo "$(limactl list dev-env --format 'unix://{{.Dir}}/sock/docker.sock')"
portForwards:
  - guestSocket: "/var/run/docker.sock"
    hostSocket: "{{.Dir}}/sock/docker.sock"

# AUTOMATION: Install Docker CE on first boot
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # --- 1. Install Docker and Python Dependencies ---
      apt-get update && apt-get install -y ca-certificates curl gnupg jq build-essential \
      libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev \
      libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev

      install -m 0755 -d /etc/apt/keyrings

      curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg

      echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      tee /etc/apt/sources.list.d/docker.list > /dev/null

      apt-get update && apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # --- 2. Configure API Version ---
      mkdir -p /etc/docker
      [ ! -f /etc/docker/daemon.json ] && echo '{}' > /etc/docker/daemon.json
      tmp=$(mktemp)
      jq '."min-api-version" = "1.24"' /etc/docker/daemon.json > "$tmp" && mv "$tmp" /etc/docker/daemon.json

      # --- 3. FIX PERMISSIONS PERMANENTLY (Replaces 'usermod') ---
      # This enables the socket for everyone, instantly.
      mkdir -p /etc/systemd/system/docker.socket.d
      cat <<EOF > /etc/systemd/system/docker.socket.d/override.conf
      [Socket]
      SocketMode=0666
      EOF

      systemctl daemon-reload
      systemctl enable --now docker.socket
      systemctl restart docker.socket

      # ZSH
      apt-get install -y zsh git

      # Add zsh to the list of valid shells
      if ! grep -q "^/usr/bin/zsh" /etc/shells; then
          echo "/usr/bin/zsh" >> /etc/shells
      fi

      # Ensure zsh is the default shell for the current user
      if [ -x "$(command -v zsh)" ]; then
          echo "Setting zsh as default shell for $LIMA_CIDATA_USER"
          chsh -s $(which zsh) $LIMA_CIDATA_USER
          # Also update the shell in /etc/passwd directly
          usermod --shell $(which zsh) $LIMA_CIDATA_USER
      fi

      # Set ZSH as default for root as well
      if [ -x "$(command -v zsh)" ]; then
          echo "Setting zsh as default shell for root"
          chsh -s $(which zsh) root
          usermod --shell $(which zsh) root
      fi

      # --- NeoVim ---
      echo "Installing core dependencies..."
      sudo apt install -y \
          git \
          curl \
          wget \
          build-essential \
          gcc \
          make \
          unzip \
          ripgrep \
          fd-find \
          nodejs \
          npm \
          lua5.1 \
          luarocks

      echo "Installing Neovim..."
      if ! command -v nvim &> /dev/null; then
          cd /tmp
          curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
          chmod u+x nvim.appimage
          sudo mv nvim.appimage /usr/local/bin/nvim
          echo "Neovim installed to /usr/local/bin/nvim"
      else
          echo "Neovim already installed, skipping..."
      fi

      if [ -f /usr/bin/fdfind ] && [ ! -f /usr/local/bin/fd ]; then
          sudo ln -s /usr/bin/fdfind /usr/local/bin/fd
          echo "Created fd symlink"
      fi

      LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
      curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
      tar xf lazygit.tar.gz lazygit
      sudo install lazygit /usr/local/bin
      rm lazygit lazygit.tar.gz
      echo "lazygit installed"
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # --- Install ASDF and Plugins ---
      git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.0

      # Add ASDF to bashrc and zshrc
      echo '. "$HOME/.asdf/asdf.sh"' >> ~/.bashrc
      echo '. "$HOME/.asdf/completions/asdf.bash"' >> ~/.bashrc
      echo '. "$HOME/.asdf/asdf.sh"' >> ~/.zshrc
      echo '. "$HOME/.asdf/completions/asdf.bash"' >> ~/.zshrc

      # Source ASDF in the current shell session
      . "$HOME/.asdf/asdf.sh"

      # Verify ASDF is working
      if ! asdf --version >/dev/null 2>&1; then
          echo "ASDF initialization failed, trying alternative approach"
          export ASDF_DIR="$HOME/.asdf"
          export PATH="$ASDF_DIR/bin:$ASDF_DIR/shims:$PATH"
      fi

      # Install Node.js Plugin
      asdf plugin-add nodejs https://github.com/asdf-vm/asdf-nodejs.git

      # Import Node.js release team keyring with proper error handling
      if [ -f ~/.asdf/plugins/nodejs/bin/import-release-team-keyring ]; then
          bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring || echo "Keyring import failed, but continuing..."
      else
          echo "Keyring import script not found, skipping..."
      fi

      # Install latest Node.js with retry logic
      if ! asdf install nodejs latest; then
          echo "Node.js installation failed, trying specific version..."
          asdf install nodejs 20.0.0 || echo "Node.js installation failed completely"
      fi

      # Set global Node.js version
      if [ -n "$(asdf list nodejs | tail -1)" ]; then
          asdf global nodejs $(asdf list nodejs | tail -1)
      else
          echo "No Node.js versions available to set as global"
      fi

      # Install Java Plugin
      asdf plugin-add java https://github.com/halcyon/asdf-java.git
      asdf install java latest:adoptopenjdk
      asdf global java $(asdf list java | tail -1)

      # Install Python Plugin
      asdf plugin-add python https://github.com/asdf-community/asdf-python.git
      asdf install python latest
      asdf global python $(asdf list python | tail -1)

      # Install pip and Mistral Vibe
      python -m ensurepip --upgrade
      python -m pip install --upgrade pip
      pip install mistral-vibe

      # Install Oh My Zsh
      sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

      echo "Backing up existing Neovim config (if any)..."
      BACKUP_DIR="$HOME/.config/nvim.backup.$(date +%Y%m%d_%H%M%S)"
      if [ -d "$HOME/.config/nvim" ]; then
          mv "$HOME/.config/nvim" "$BACKUP_DIR"
          echo "Backed up to $BACKUP_DIR"
      fi

      [ -d "$HOME/.local/share/nvim" ] && mv "$HOME/.local/share/nvim" "$HOME/.local/share/nvim.bak"
      [ -d "$HOME/.local/state/nvim" ] && mv "$HOME/.local/state/nvim" "$HOME/.local/state/nvim.bak"
      [ -d "$HOME/.cache/nvim" ] && mv "$HOME/.cache/nvim" "$HOME/.cache/nvim.bak"

      git clone https://github.com/LazyVim/starter ~/.config/nvim
      rm -rf ~/.config/nvim/.git

      # Install Brew
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      echo >> $HOME/.zshrc
      echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv zsh)"' >> $HOME/.zshrc
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv zsh)"

      brew install gcc

      brew install git-xet
      git xet install

# Health Check: Wait until all provisioning is complete
probes:
  - script: |
      #!/bin/bash
      set -eux -o pipefail

      # Wait for Docker to be installed and running
      if ! timeout 60s bash -c "until command -v docker >/dev/null 2>&1; do sleep 3; done"; then
        echo >&2 "docker is not installed yet"
        exit 1
      fi
      if ! timeout 60s bash -c "until pgrep dockerd; do sleep 3; done"; then
        echo >&2 "dockerd is not running"
        exit 1
      fi

      if ! timeout 60s bash -c "until /home/linuxbrew/.linuxbrew/bin/brew list | grep -q 'git-xet'; do sleep 5; done"; then
        echo >&2 "git-xet is not installed yet"
        exit 1
      fi
    hint: See "/var/log/cloud-init-output.log" in the guest
